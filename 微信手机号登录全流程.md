# 微信小程序手机号登录全流程

## 一、概述

本文档描述微信小程序手机号登录的完整实现流程，包括前端获取手机号、后端验证、用户信息存储等环节。

## 二、技术方案

### 2.1 登录流程图

```
用户点击授权按钮
    ↓
触发 getPhoneNumber 事件
    ↓
获取 code (动态令牌)
    ↓
调用 wx.login() 获取登录凭证
    ↓
发送 code 和登录凭证到后端
    ↓
后端调用微信接口解密手机号
    ↓
验证并存储用户信息
    ↓
返回用户信息和 token
    ↓
前端存储 token 并跳转
```

## 三、前端实现

### 3.1 创建登录页面

**pages/login/login.wxml**

```xml
<view class="login-container">
  <view class="header">
    <image class="logo" src="/images/logo.png"></image>
    <text class="title">AI 旅行助手</text>
    <text class="subtitle">智能规划，精彩旅程</text>
  </view>

  <view class="content">
    <view class="info-tips">
      <text>登录后可以使用以下功能：</text>
      <view class="tips-list">
        <text>• 保存旅行计划</text>
        <text>• 收藏目的地</text>
        <text>• 查看历史记录</text>
        <text>• 个性化推荐</text>
      </view>
    </view>

    <button
      class="login-btn"
      open-type="getPhoneNumber"
      bindgetphonenumber="getPhoneNumber"
      wx:if="{{!hasUserInfo}}"
    >
      <image class="btn-icon" src="/images/phone.png"></image>
      <text>手机号快捷登录</text>
    </button>

    <view class="agreement">
      <text>登录即表示同意</text>
      <text class="link" bindtap="viewAgreement">《用户协议》</text>
      <text>和</text>
      <text class="link" bindtap="viewPrivacy">《隐私政策》</text>
    </view>
  </view>
</view>
```

### 3.2 登录页面逻辑

**pages/login/login.js**

```javascript
Page({
  data: {
    hasUserInfo: false
  },

  onLoad() {
    // 检查是否已登录
    const token = wx.getStorageSync('token');
    if (token) {
      this.checkTokenValid(token);
    }
  },

  /**
   * 获取手机号授权
   */
  getPhoneNumber(e) {
    if (e.detail.errMsg === 'getPhoneNumber:ok') {
      const code = e.detail.code;

      // 显示加载提示
      wx.showLoading({
        title: '登录中...',
        mask: true
      });

      // 获取微信登录凭证
      wx.login({
        success: (res) => {
          if (res.code) {
            this.loginToBackend(res.code, code);
          } else {
            this.handleLoginError('获取登录凭证失败');
          }
        },
        fail: () => {
          this.handleLoginError('获取登录凭证失败');
        }
      });
    } else {
      wx.showToast({
        title: '您取消了授权',
        icon: 'none'
      });
    }
  },

  /**
   * 调用后端登录接口
   */
  loginToBackend(loginCode, phoneCode) {
    wx.request({
      url: 'https://your-api.com/api/user/login',
      method: 'POST',
      data: {
        loginCode: loginCode,    // wx.login 获取的 code
        phoneCode: phoneCode      // getPhoneNumber 获取的 code
      },
      success: (res) => {
        wx.hideLoading();

        if (res.data.code === 200) {
          const { token, userInfo } = res.data.data;

          // 存储 token 和用户信息
          wx.setStorageSync('token', token);
          wx.setStorageSync('userInfo', userInfo);

          wx.showToast({
            title: '登录成功',
            icon: 'success',
            duration: 1500
          });

          // 延迟跳转到首页或返回上一页
          setTimeout(() => {
            const pages = getCurrentPages();
            if (pages.length > 1) {
              wx.navigateBack();
            } else {
              wx.reLaunch({
                url: '/pages/index/index'
              });
            }
          }, 1500);
        } else {
          this.handleLoginError(res.data.message || '登录失败');
        }
      },
      fail: (err) => {
        this.handleLoginError('网络请求失败');
      }
    });
  },

  /**
   * 检查 token 有效性
   */
  checkTokenValid(token) {
    wx.request({
      url: 'https://your-api.com/api/user/checkToken',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`
      },
      success: (res) => {
        if (res.data.code === 200) {
          // Token 有效，直接返回
          wx.navigateBack();
        } else {
          // Token 失效，清除本地存储
          wx.removeStorageSync('token');
          wx.removeStorageSync('userInfo');
        }
      }
    });
  },

  /**
   * 处理登录错误
   */
  handleLoginError(message) {
    wx.hideLoading();
    wx.showModal({
      title: '登录失败',
      content: message,
      showCancel: false
    });
  },

  /**
   * 查看用户协议
   */
  viewAgreement() {
    wx.navigateTo({
      url: '/pages/agreement/agreement'
    });
  },

  /**
   * 查看隐私政策
   */
  viewPrivacy() {
    wx.navigateTo({
      url: '/pages/privacy/privacy'
    });
  }
});
```

### 3.3 登录页面样式

**pages/login/login.wxss**

```css
.login-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 0 40rpx;
}

.header {
  padding-top: 120rpx;
  text-align: center;
}

.logo {
  width: 160rpx;
  height: 160rpx;
  border-radius: 80rpx;
  background: white;
}

.title {
  display: block;
  margin-top: 40rpx;
  font-size: 48rpx;
  font-weight: bold;
  color: white;
}

.subtitle {
  display: block;
  margin-top: 16rpx;
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.8);
}

.content {
  margin-top: 160rpx;
}

.info-tips {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 24rpx;
  padding: 40rpx;
  margin-bottom: 60rpx;
}

.info-tips > text {
  font-size: 28rpx;
  color: #333;
  font-weight: bold;
}

.tips-list {
  margin-top: 24rpx;
}

.tips-list text {
  display: block;
  font-size: 26rpx;
  color: #666;
  line-height: 60rpx;
}

.login-btn {
  width: 100%;
  height: 96rpx;
  background: white;
  border-radius: 48rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.15);
}

.btn-icon {
  width: 40rpx;
  height: 40rpx;
  margin-right: 16rpx;
}

.login-btn text {
  font-size: 32rpx;
  color: #667eea;
  font-weight: bold;
}

.agreement {
  margin-top: 40rpx;
  text-align: center;
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.8);
}

.agreement .link {
  color: white;
  text-decoration: underline;
}
```

### 3.4 页面配置

**pages/login/login.json**

```json
{
  "navigationBarTitleText": "登录",
  "navigationBarBackgroundColor": "#667eea",
  "navigationBarTextStyle": "white"
}
```

## 四、后端实现

### 4.1 Node.js + Express 示例

**接口：POST /api/user/login**

```javascript
const express = require('express');
const axios = require('axios');
const jwt = require('jsonwebtoken');
const router = express.Router();

// 微信小程序配置
const APPID = 'your_appid';
const SECRET = 'your_secret';
const JWT_SECRET = 'your_jwt_secret';

/**
 * 手机号登录接口
 */
router.post('/login', async (req, res) => {
  const { loginCode, phoneCode } = req.body;

  if (!loginCode || !phoneCode) {
    return res.json({
      code: 400,
      message: '参数缺失'
    });
  }

  try {
    // 1. 通过 loginCode 获取 session_key 和 openid
    const loginResult = await getWxLoginInfo(loginCode);
    if (!loginResult.success) {
      return res.json({
        code: 500,
        message: loginResult.message
      });
    }

    const { openid, session_key } = loginResult.data;

    // 2. 通过 phoneCode 获取手机号
    const phoneResult = await getPhoneNumber(phoneCode);
    if (!phoneResult.success) {
      return res.json({
        code: 500,
        message: phoneResult.message
      });
    }

    const { phoneNumber, purePhoneNumber, countryCode } = phoneResult.data;

    // 3. 查询或创建用户
    let user = await findUserByOpenid(openid);

    if (!user) {
      // 创建新用户
      user = await createUser({
        openid,
        phone: purePhoneNumber,
        countryCode,
        createdAt: new Date()
      });
    } else {
      // 更新用户信息
      user = await updateUser(openid, {
        phone: purePhoneNumber,
        countryCode,
        lastLoginAt: new Date()
      });
    }

    // 4. 生成 JWT token
    const token = jwt.sign(
      {
        userId: user.id,
        openid: user.openid
      },
      JWT_SECRET,
      { expiresIn: '30d' }
    );

    // 5. 返回用户信息
    res.json({
      code: 200,
      message: '登录成功',
      data: {
        token,
        userInfo: {
          id: user.id,
          phone: user.phone,
          nickname: user.nickname,
          avatar: user.avatar
        }
      }
    });

  } catch (error) {
    console.error('登录失败：', error);
    res.json({
      code: 500,
      message: '服务器错误'
    });
  }
});

/**
 * 获取微信登录信息
 */
async function getWxLoginInfo(code) {
  try {
    const url = `https://api.weixin.qq.com/sns/jscode2session`;
    const response = await axios.get(url, {
      params: {
        appid: APPID,
        secret: SECRET,
        js_code: code,
        grant_type: 'authorization_code'
      }
    });

    const data = response.data;

    if (data.errcode) {
      return {
        success: false,
        message: `微信接口错误：${data.errmsg}`
      };
    }

    return {
      success: true,
      data: {
        openid: data.openid,
        session_key: data.session_key
      }
    };
  } catch (error) {
    return {
      success: false,
      message: '获取微信登录信息失败'
    };
  }
}

/**
 * 获取手机号（需要获取 access_token）
 */
async function getPhoneNumber(code) {
  try {
    // 1. 获取 access_token
    const tokenUrl = `https://api.weixin.qq.com/cgi-bin/token`;
    const tokenResponse = await axios.get(tokenUrl, {
      params: {
        grant_type: 'client_credential',
        appid: APPID,
        secret: SECRET
      }
    });

    const access_token = tokenResponse.data.access_token;

    if (!access_token) {
      return {
        success: false,
        message: '获取 access_token 失败'
      };
    }

    // 2. 获取手机号
    const phoneUrl = `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${access_token}`;
    const phoneResponse = await axios.post(phoneUrl, {
      code: code
    });

    const phoneData = phoneResponse.data;

    if (phoneData.errcode !== 0) {
      return {
        success: false,
        message: `获取手机号失败：${phoneData.errmsg}`
      };
    }

    return {
      success: true,
      data: phoneData.phone_info
    };
  } catch (error) {
    return {
      success: false,
      message: '获取手机号失败'
    };
  }
}

/**
 * 根据 openid 查询用户
 */
async function findUserByOpenid(openid) {
  // 数据库查询逻辑（示例使用伪代码）
  // return await db.query('SELECT * FROM users WHERE openid = ?', [openid]);
  return null; // 请替换为实际数据库查询
}

/**
 * 创建新用户
 */
async function createUser(userData) {
  // 数据库插入逻辑（示例使用伪代码）
  // return await db.insert('users', userData);
  return { id: 1, ...userData }; // 请替换为实际数据库操作
}

/**
 * 更新用户信息
 */
async function updateUser(openid, userData) {
  // 数据库更新逻辑（示例使用伪代码）
  // return await db.update('users', userData, { openid });
  return { id: 1, openid, ...userData }; // 请替换为实际数据库操作
}

/**
 * 校验 token
 */
router.post('/checkToken', authenticateToken, (req, res) => {
  res.json({
    code: 200,
    message: 'Token 有效',
    data: req.user
  });
});

/**
 * JWT 认证中间件
 */
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.json({
      code: 401,
      message: '未授权'
    });
  }

  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) {
      return res.json({
        code: 403,
        message: 'Token 无效或已过期'
      });
    }
    req.user = user;
    next();
  });
}

module.exports = router;
```

### 4.2 数据库设计

**users 表结构（MySQL 示例）**

```sql
CREATE TABLE `users` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `openid` varchar(64) NOT NULL COMMENT '微信 openid',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `country_code` varchar(10) DEFAULT '86' COMMENT '国家代码',
  `nickname` varchar(100) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

## 五、全局登录拦截

### 5.1 封装请求工具

**utils/request.js**

```javascript
const BASE_URL = 'https://your-api.com/api';

/**
 * 封装的请求方法
 */
function request(options) {
  const token = wx.getStorageSync('token');

  return new Promise((resolve, reject) => {
    wx.request({
      url: BASE_URL + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      },
      success: (res) => {
        // 未授权，跳转登录
        if (res.data.code === 401 || res.data.code === 403) {
          wx.removeStorageSync('token');
          wx.removeStorageSync('userInfo');

          wx.showModal({
            title: '提示',
            content: '登录已过期，请重新登录',
            showCancel: false,
            success: () => {
              wx.redirectTo({
                url: '/pages/login/login'
              });
            }
          });
          reject(res.data);
          return;
        }

        if (res.data.code === 200) {
          resolve(res.data.data);
        } else {
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          });
          reject(res.data);
        }
      },
      fail: (err) => {
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        });
        reject(err);
      }
    });
  });
}

module.exports = {
  get: (url, data) => request({ url, method: 'GET', data }),
  post: (url, data) => request({ url, method: 'POST', data }),
  put: (url, data) => request({ url, method: 'PUT', data }),
  delete: (url, data) => request({ url, method: 'DELETE', data })
};
```

### 5.2 检查登录状态

**utils/auth.js**

```javascript
/**
 * 检查是否已登录
 */
function checkLogin() {
  const token = wx.getStorageSync('token');
  return !!token;
}

/**
 * 要求用户登录
 */
function requireLogin() {
  if (!checkLogin()) {
    wx.showModal({
      title: '提示',
      content: '此功能需要登录后使用',
      confirmText: '去登录',
      success: (res) => {
        if (res.confirm) {
          wx.navigateTo({
            url: '/pages/login/login'
          });
        }
      }
    });
    return false;
  }
  return true;
}

/**
 * 获取用户信息
 */
function getUserInfo() {
  return wx.getStorageSync('userInfo');
}

module.exports = {
  checkLogin,
  requireLogin,
  getUserInfo
};
```

## 六、使用示例

### 6.1 在页面中使用

```javascript
const auth = require('../../utils/auth');
const request = require('../../utils/request');

Page({
  // 收藏行程
  saveTripPlan() {
    // 检查登录状态
    if (!auth.requireLogin()) {
      return;
    }

    // 已登录，继续业务逻辑
    request.post('/trip/save', {
      city: this.data.city,
      days: this.data.days,
      tripDays: this.data.tripDays
    }).then(res => {
      wx.showToast({
        title: '保存成功',
        icon: 'success'
      });
    });
  }
});
```

## 七、注意事项

### 7.1 微信小程序配置

1. **开通手机号快速验证组件**
   - 登录微信公众平台
   - 进入"设置" → "接口设置"
   - 开通"手机号快速验证组件"

2. **配置服务器域名**
   - request 合法域名：添加您的后端 API 域名
   - downloadFile 合法域名：如需下载文件

3. **用户隐私保护指引**
   - 在小程序管理后台配置隐私政策
   - 说明手机号的使用目的和范围

### 7.2 安全建议

1. **后端验证**
   - 必须在后端调用微信接口解密手机号
   - 不要相信前端传来的任何用户信息
   - 使用 HTTPS 协议

2. **Token 管理**
   - 使用 JWT 等安全的 token 机制
   - 设置合理的过期时间
   - 支持 token 刷新机制

3. **数据安全**
   - 手机号等敏感信息加密存储
   - 做好数据脱敏
   - 遵守隐私保护法规

### 7.3 用户体验优化

1. **友好提示**
   - 清晰说明为什么需要手机号
   - 授权失败时给出明确提示
   - 提供其他登录方式（可选）

2. **流畅跳转**
   - 登录成功后返回原页面
   - 避免重复登录提示
   - 保持登录状态

3. **错误处理**
   - 网络错误重试机制
   - 授权失败降级方案
   - 完善的错误提示

## 八、测试清单

- [ ] 首次授权登录流程
- [ ] 拒绝授权的处理
- [ ] Token 过期后重新登录
- [ ] 网络异常的处理
- [ ] 多个页面的登录拦截
- [ ] 登录状态持久化
- [ ] 退出登录功能
- [ ] 接口鉴权测试

## 九、常见问题

### Q1: getPhoneNumber 回调没有返回 code？

**A:** 检查以下几点：
- 小程序是否已认证
- 是否开通了"手机号快速验证组件"
- button 组件是否正确设置 `open-type="getPhoneNumber"`

### Q2: 后端获取手机号返回 40001 错误？

**A:** access_token 无效或过期，建议：
- 实现 access_token 缓存机制（有效期 2 小时）
- 错误时自动重新获取 access_token

### Q3: 如何实现多端登录？

**A:** 可以为每个登录终端生成不同的 token，并在数据库中维护多个 session。

## 十、相关文档

- [微信小程序登录文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
- [手机号快速验证组件](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [微信服务端 API](https://developers.weixin.qq.com/miniprogram/dev/api-backend/)
