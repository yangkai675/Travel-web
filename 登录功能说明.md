# 微信小程序登录功能说明

## 功能概述

已成功集成微信登录功能，使用 `wx.login` 获取 code 发送给后端解析 openid 和 unionid。

## 实现方式

### 1. 登录流程

```
用户点击登录按钮
    ↓
调用 wx.login() 获取 code
    ↓
发送 code 到后端接口 POST /user/login
    ↓
后端解析 openid/unionid 并返回 token
    ↓
前端存储 token 和 userInfo
    ↓
登录成功
```

### 2. 页面权限控制

- **首页（pages/index）**: 无需登录，任何人都可以访问
- **详情页（pages/detail）**: 需要登录才能访问
  - 未登录用户会看到提示弹窗
  - 点击"去登录"跳转到登录页
  - 登录成功后自动返回

### 3. 核心文件

#### utils/auth.js - 认证工具
```javascript
// 主要方法：
login()           // 微信登录
checkLogin()      // 检查是否已登录
requireLogin()    // 要求登录（含拦截）
getUserInfo()     // 获取用户信息
logout()          // 退出登录
checkTokenValid() // 检查 token 有效性
```

#### pages/login - 登录页面
- **login.wxml**: 登录页面UI
- **login.js**: 登录逻辑
- **login.wxss**: 登录页面样式
- **login.json**: 页面配置

#### conf/s.js - 服务器配置
```javascript
export const SERVER_IP = 'https://springboot-ff8y-207643-6-1391761948.sh.run.tcloudbase.com';
```

## 后端接口要求

### 1. 登录接口

```http
POST /user/login
Content-Type: application/json

{
  "code": "wx.login获取的code"
}
```

**响应格式：**
```json
{
  "code": 200,
  "data": {
    "token": "用户token",
    "userInfo": {
      "openid": "用户openid",
      "unionid": "用户unionid（如果有）",
      "nickname": "用户昵称（可选）",
      "avatar": "用户头像（可选）"
    }
  },
  "message": "登录成功"
}
```

### 2. Token 验证接口

```http
POST /user/checkToken
Authorization: Bearer {token}
```

**响应格式：**
```json
{
  "code": 200,
  "message": "token有效"
}
```

## 存储结构

小程序本地存储：

- **token**: 用户登录凭证
- **userInfo**: 用户信息对象

## 使用示例

### 在其他页面添加登录检查

```javascript
// 在页面的 onLoad 或需要检查登录的方法中
const auth = require('../../utils/auth');

// 方式1：简单检查
if (!auth.checkLogin()) {
  wx.showToast({
    title: '请先登录',
    icon: 'none'
  });
  return;
}

// 方式2：带拦截提示（推荐）
if (!auth.requireLogin()) {
  return; // requireLogin 会自动弹窗并跳转
}
```

### 获取用户信息

```javascript
const auth = require('../../utils/auth');
const userInfo = auth.getUserInfo();
console.log('当前用户:', userInfo);
```

### 退出登录

```javascript
const auth = require('../../utils/auth');
auth.logout(); // 会清除本地存储并跳转首页
```

## 测试流程

1. **测试未登录访问详情页**
   - 打开小程序首页
   - 不登录，直接点击"生成我的专属攻略"
   - 应该弹出提示"此功能需要登录后使用"
   - 点击"去登录"跳转到登录页

2. **测试登录流程**
   - 在登录页点击"微信快捷登录"
   - 系统自动调用 wx.login 获取 code
   - 发送到后端完成登录
   - 登录成功后自动返回上一页

3. **测试已登录访问**
   - 登录后点击"生成我的专属攻略"
   - 应该直接进入详情页，不再提示登录

4. **测试 token 持久化**
   - 登录成功后关闭小程序
   - 重新打开小程序
   - 应该保持登录状态

## 注意事项

1. **微信小程序登录配置**
   - 需要在微信公众平台配置小程序的 AppID 和 AppSecret
   - 后端需要使用这些信息解析 code 获取 openid

2. **服务器域名配置**
   - 在小程序后台配置合法域名：`https://springboot-ff8y-207643-6-1391761948.sh.run.tcloudbase.com`
   - 开发阶段可以在开发者工具中勾选"不校验合法域名"

3. **错误处理**
   - 网络错误会自动提示
   - Token 失效会自动跳转登录页
   - 后端错误会显示错误信息

4. **安全建议**
   - Token 应设置合理的过期时间
   - 重要操作建议再次验证登录状态
   - 敏感信息不要存储在本地

## 后续优化建议

1. 添加用户中心页面，展示用户信息
2. 添加退出登录按钮
3. 支持用户昵称和头像展示
4. 添加登录状态过期自动刷新
5. 添加更多需要登录才能使用的功能
